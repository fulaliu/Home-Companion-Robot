<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ROS WebSocket åŒè·¯è§†é¢‘ + é”®ç›˜æ§åˆ¶</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light dark;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; align-items: center; margin: 10px 0; flex-wrap: wrap; }
    input[type="text"] { width: 220px; padding: 6px 8px; }
    button { padding: 8px 12px; cursor: pointer; }
    .status { font-weight: 600; padding: 2px 6px; border-radius: 4px; }
    .ok { color: #0a0; }
    .ng { color: #a00; }
    .muted { color: #666; font-size: 12px; }
    .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
    figure { margin: 0; }
    figcaption { font-size: 13px; color: #888; margin-top: 4px; }
    .videos img { width: 100%; background: #000; aspect-ratio: 16/9; object-fit: contain; }
    #log { height: 160px; overflow: auto; border: 1px solid #ccc; padding: 8px; white-space: pre-wrap; background: #f8f8f8; }
    .pad { display: grid; grid-template-columns: 64px 64px 64px; grid-template-rows: 46px 46px 46px; gap: 6px; }
    .pad button { height: 46px; }
    .right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
    .sep { width: 1px; height: 18px; background: #ccc; margin: 0 6px; }
    code.k { background: #eee; padding: 1px 4px; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>ROS WebSocket åŒè·¯è§†é¢‘ï¼ˆcam0/cam1ï¼‰+ é”®ç›˜æ§åˆ¶</h2>

  <div class="row">
    <label for="ip">Robot IPï¼š</label>
    <input id="ip" type="text" placeholder="ä¾‹å¦‚ï¼š192.168.1.42" />
    <button id="btnConnect">è¿æ¥</button>
    <button id="btnDisconnect" disabled>æ–­å¼€</button>

    <div class="right">
      <span>cam0: <span id="stCam0" class="status ng">æœªè¿æ¥</span></span>
      <span class="sep"></span>
      <span>cam1: <span id="stCam1" class="status ng">æœªè¿æ¥</span></span>
      <span class="sep"></span>
      <span>æ§åˆ¶: <span id="stCmd" class="status ng">æœªè¿æ¥</span></span>
    </div>
  </div>

  <div class="row">
    <div class="pad">
      <span></span>
      <button id="btnUp">â†‘</button>
      <span></span>

      <button id="btnLeft">â†</button>
      <button id="btnStop">â– </button>
      <button id="btnRight">â†’</button>

      <span></span>
      <button id="btnDown">â†“</button>
      <span></span>
    </div>
    <div class="muted">
      é”®ç›˜å¿«æ·é”®ï¼š
      <code class="k">â†‘</code> forwardï¼Œ
      <code class="k">â†“</code> backwardï¼Œ
      <code class="k">â†</code> leftï¼Œ
      <code class="k">â†’</code> rightï¼Œ
      <code class="k">Space</code> stop
      <br />
      ä¹Ÿå¯å‘é€è‡ªå®šä¹‰é€Ÿåº¦ï¼ˆç¤ºä¾‹ï¼š<code>{"linear":0.3,"angular":-0.2}</code>ï¼‰
      <div style="margin-top:6px;">
        <button id="btnLinAng">å‘é€çº¿é€Ÿåº¦0.3/è§’é€Ÿåº¦-0.2</button>
      </div>
    </div>
  </div>

  <div class="row videos">
    <figure>
      <img id="imgCam0" alt="cam0 ç­‰å¾…è§†é¢‘â€¦">
      <figcaption>cam0ï¼ˆws://&lt;ip&gt;:8765ï¼‰</figcaption>
    </figure>
    <figure>
      <img id="imgCam1" alt="cam1 ç­‰å¾…è§†é¢‘â€¦">
      <figcaption>cam1ï¼ˆws://&lt;ip&gt;:8766ï¼‰</figcaption>
    </figure>
  </div>

  <div class="row" style="align-items: stretch;">
    <div style="flex:1;">
      <div><strong>æ—¥å¿—</strong></div>
      <div id="log"></div>
    </div>
  </div>

<script>
(function(){
  /*** Elements ***/
  const ipEl = document.getElementById('ip');
  const stCam0 = document.getElementById('stCam0');
  const stCam1 = document.getElementById('stCam1');
  const stCmd  = document.getElementById('stCmd');
  const btnConnect = document.getElementById('btnConnect');
  const btnDisconnect = document.getElementById('btnDisconnect');
  const imgCam0 = document.getElementById('imgCam0');
  const imgCam1 = document.getElementById('imgCam1');
  const logEl = document.getElementById('log');

  const btnUp = document.getElementById('btnUp');
  const btnDown = document.getElementById('btnDown');
  const btnLeft = document.getElementById('btnLeft');
  const btnRight = document.getElementById('btnRight');
  const btnStop = document.getElementById('btnStop');
  const btnLinAng = document.getElementById('btnLinAng');

  /*** State ***/
  let wsCam0 = null, wsCam1 = null, wsCmd = null;
  let reconnectTimers = { cam0: null, cam1: null, cmd: null };
  let lastUrl0 = null, lastUrl1 = null;
  let connecting = false;

  // Allow query param ?ip=1.2.3.4
  (function initByQuery(){
    const u = new URL(location.href);
    const p = u.searchParams.get('ip');
    if (p) ipEl.value = p;
  })();

  function log(msg) {
    const ts = new Date().toLocaleTimeString();
    logEl.textContent += `[${ts}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
    // console.log(msg);
  }

  function setStatus(el, ok, text) {
    el.textContent = text || (ok ? 'å·²è¿æ¥' : 'æœªè¿æ¥');
    el.classList.toggle('ok', !!ok);
    el.classList.toggle('ng', !ok);
  }

  function revokeURL(which){
    try {
      if (which === 0 && lastUrl0) { URL.revokeObjectURL(lastUrl0); lastUrl0 = null; }
      if (which === 1 && lastUrl1) { URL.revokeObjectURL(lastUrl1); lastUrl1 = null; }
    } catch {}
  }

  function buildUrls(ip){
    const base = `ws://${ip}`;
    return {
      cam0: `${base}:8765`,
      cam1: `${base}:8766`,
      cmd : `${base}:8888`
    };
  }

  function scheduleReconnect(kind, fn, delayMs){
    // simple debounce
    if (reconnectTimers[kind]) return;
    reconnectTimers[kind] = setTimeout(() => {
      reconnectTimers[kind] = null;
      fn();
    }, delayMs);
  }

  /*** Video connections (binary JPEG) ***/
  function connectCam(kind, url, imgEl, statusEl, revokeIdx){
    let ws;
    try {
      ws = new WebSocket(url);
    } catch (e) {
      log(`åˆ›å»º ${kind} WebSocket å¤±è´¥ï¼š${e}`);
      return null;
    }
    ws.binaryType = 'arraybuffer';

    ws.onopen = () => {
      setStatus(statusEl, true);
      log(`âœ… ${kind} connected: ${url}`);
      // ç»‘å®šåˆ°å…¨å±€
      if (kind === 'cam0') wsCam0 = ws;
      if (kind === 'cam1') wsCam1 = ws;
    };

    ws.onmessage = (ev) => {
      if (typeof ev.data === 'string') {
        // ä¸€èˆ¬ä¸ä¼šæ”¶åˆ°æ–‡æœ¬ï¼›å¦‚åç«¯å‘äº†æ–‡æœ¬ï¼Œåˆ™åªè®°å½•
        log(`${kind} æ–‡æœ¬: ${ev.data}`);
        return;
      }
      let blob;
      if (ev.data instanceof ArrayBuffer) {
        blob = new Blob([ev.data], { type: 'image/jpeg' });
      } else if (ev.data instanceof Blob) {
        blob = ev.data;
      } else {
        return;
      }
      const urlObj = URL.createObjectURL(blob);
      if (revokeIdx === 0) {
        revokeURL(0);
        lastUrl0 = urlObj;
      } else {
        revokeURL(1);
        lastUrl1 = urlObj;
      }
      // è®¾ç½® src æ—¶ä¸ç”¨ revoke å½“å‰ urlï¼Œé¿å…è¿˜æœªè§£ç å¯¼è‡´èŠ±å±
      imgEl.src = urlObj;
    };

    ws.onerror = (err) => {
      log(`âŒ ${kind} error: ${err?.message || err}`);
    };

    ws.onclose = (ev) => {
      setStatus(statusEl, false, `æ–­å¼€(${ev.code})`);
      log(`ğŸ”Œ ${kind} disconnected. code=${ev.code} reason=${ev.reason || 'n/a'}`);
      revokeURL(revokeIdx);
      if (imgEl) imgEl.removeAttribute('src');
      // å°è¯•é‡è¿
      scheduleReconnect(kind, () => {
        const ip = ipEl.value.trim();
        if (!ip) return;
        const urls = buildUrls(ip);
        if (kind === 'cam0') connectCam('cam0', urls.cam0, imgCam0, stCam0, 0);
        if (kind === 'cam1') connectCam('cam1', urls.cam1, imgCam1, stCam1, 1);
      }, 1500);
    };

    return ws;
  }

  /*** Command connection ***/
  function connectCmd(url){
    let ws;
    try {
      ws = new WebSocket(url);
    } catch (e) {
      log(`åˆ›å»º cmd WebSocket å¤±è´¥ï¼š${e}`);
      return null;
    }
    ws.onopen = () => {
      setStatus(stCmd, true);
      log(`âœ… cmd connected: ${url}`);
      wsCmd = ws;
    };
    ws.onerror = (err) => {
      log(`âŒ cmd error: ${err?.message || err}`);
    };
    ws.onclose = (ev) => {
      setStatus(stCmd, false, `æ–­å¼€(${ev.code})`);
      log(`ğŸ”Œ cmd disconnected. code=${ev.code} reason=${ev.reason || 'n/a'}`);
      scheduleReconnect('cmd', () => {
        const ip = ipEl.value.trim();
        if (!ip) return;
        const { cmd } = buildUrls(ip);
        connectCmd(cmd);
      }, 1500);
    };
    return ws;
  }

  function sendCmd(payload) {
    if (!wsCmd || wsCmd.readyState !== WebSocket.OPEN) {
      log('cmd å°šæœªè¿æ¥ï¼Œæ— æ³•å‘é€æŒ‡ä»¤ã€‚');
      return;
    }
    try {
      const text = JSON.stringify(payload);
      wsCmd.send(text);
      log(`â¡ cmd: ${text}`);
    } catch (e) {
      log(`cmd å‘é€å¤±è´¥: ${e}`);
    }
  }

  /*** UI bindings ***/
  btnConnect.addEventListener('click', () => {
    if (connecting) return;
    const ip = ipEl.value.trim();
    if (!ip) {
      log('è¯·å…ˆå¡«å†™ Robot IP');
      ipEl.focus();
      return;
    }
    connecting = true;
    btnConnect.disabled = true;
    btnDisconnect.disabled = false;

    const { cam0, cam1, cmd } = buildUrls(ip);
    connectCam('cam0', cam0, imgCam0, stCam0, 0);
    connectCam('cam1', cam1, imgCam1, stCam1, 1);
    connectCmd(cmd);

    setTimeout(() => { connecting = false; }, 500);
  });

  btnDisconnect.addEventListener('click', () => {
    btnConnect.disabled = false;
    btnDisconnect.disabled = true;

    // æ¸…ç†é‡è¿è®¡æ—¶å™¨
    for (const k of Object.keys(reconnectTimers)) {
      if (reconnectTimers[k]) {
        clearTimeout(reconnectTimers[k]);
        reconnectTimers[k] = null;
      }
    }
    try { wsCam0 && wsCam0.close(1000, 'client close'); } catch {}
    try { wsCam1 && wsCam1.close(1000, 'client close'); } catch {}
    try { wsCmd && wsCmd.close(1000, 'client close'); } catch {}

    wsCam0 = wsCam1 = wsCmd = null;
    setStatus(stCam0, false);
    setStatus(stCam1, false);
    setStatus(stCmd,  false);
    revokeURL(0); revokeURL(1);
    imgCam0.removeAttribute('src');
    imgCam1.removeAttribute('src');
  });

  // æ§åˆ¶æŒ‰é’®ï¼ˆå‘é€ actionï¼‰
  btnUp.addEventListener('click',    () => sendCmd({ action: 'forward' }));
  btnDown.addEventListener('click',  () => sendCmd({ action: 'backward' }));
  btnLeft.addEventListener('click',  () => sendCmd({ action: 'left' }));
  btnRight.addEventListener('click', () => sendCmd({ action: 'right' }));
  btnStop.addEventListener('click',  () => sendCmd({ action: 'stop' }));
  btnLinAng.addEventListener('click',() => sendCmd({ linear: 0.3, angular: -0.2 }));

  // é”®ç›˜å¿«æ·é”®
  window.addEventListener('keydown', (ev) => {
    switch (ev.key) {
      case 'ArrowUp':    ev.preventDefault(); return sendCmd({ action: 'forward' });
      case 'ArrowDown':  ev.preventDefault(); return sendCmd({ action: 'backward' });
      case 'ArrowLeft':  ev.preventDefault(); return sendCmd({ action: 'left' });
      case 'ArrowRight': ev.preventDefault(); return sendCmd({ action: 'right' });
      case ' ':          ev.preventDefault(); return sendCmd({ action: 'stop' });
    }
  });

  // é¡µé¢å…³é—­æ—¶æ¸…ç†
  window.addEventListener('beforeunload', () => {
    try { wsCam0 && wsCam0.close(1000, 'bye'); } catch {}
    try { wsCam1 && wsCam1.close(1000, 'bye'); } catch {}
    try { wsCmd  && wsCmd.close(1000, 'bye'); } catch {}
    revokeURL(0); revokeURL(1);
  });
})();
</script>
</body>
</html>
``